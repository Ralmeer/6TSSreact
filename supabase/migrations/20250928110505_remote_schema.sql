revoke delete on table "public"."activities" from "anon";

revoke insert on table "public"."activities" from "anon";

revoke references on table "public"."activities" from "anon";

revoke select on table "public"."activities" from "anon";

revoke trigger on table "public"."activities" from "anon";

revoke truncate on table "public"."activities" from "anon";

revoke update on table "public"."activities" from "anon";

revoke delete on table "public"."activities" from "authenticated";

revoke insert on table "public"."activities" from "authenticated";

revoke references on table "public"."activities" from "authenticated";

revoke select on table "public"."activities" from "authenticated";

revoke trigger on table "public"."activities" from "authenticated";

revoke truncate on table "public"."activities" from "authenticated";

revoke update on table "public"."activities" from "authenticated";

revoke delete on table "public"."activities" from "service_role";

revoke insert on table "public"."activities" from "service_role";

revoke references on table "public"."activities" from "service_role";

revoke select on table "public"."activities" from "service_role";

revoke trigger on table "public"."activities" from "service_role";

revoke truncate on table "public"."activities" from "service_role";

revoke update on table "public"."activities" from "service_role";

revoke delete on table "public"."attendance" from "anon";

revoke insert on table "public"."attendance" from "anon";

revoke references on table "public"."attendance" from "anon";

revoke select on table "public"."attendance" from "anon";

revoke trigger on table "public"."attendance" from "anon";

revoke truncate on table "public"."attendance" from "anon";

revoke update on table "public"."attendance" from "anon";

revoke delete on table "public"."attendance" from "authenticated";

revoke insert on table "public"."attendance" from "authenticated";

revoke references on table "public"."attendance" from "authenticated";

revoke select on table "public"."attendance" from "authenticated";

revoke trigger on table "public"."attendance" from "authenticated";

revoke truncate on table "public"."attendance" from "authenticated";

revoke update on table "public"."attendance" from "authenticated";

revoke delete on table "public"."attendance" from "service_role";

revoke insert on table "public"."attendance" from "service_role";

revoke references on table "public"."attendance" from "service_role";

revoke select on table "public"."attendance" from "service_role";

revoke trigger on table "public"."attendance" from "service_role";

revoke truncate on table "public"."attendance" from "service_role";

revoke update on table "public"."attendance" from "service_role";

revoke delete on table "public"."attendance_scouts" from "anon";

revoke insert on table "public"."attendance_scouts" from "anon";

revoke references on table "public"."attendance_scouts" from "anon";

revoke select on table "public"."attendance_scouts" from "anon";

revoke trigger on table "public"."attendance_scouts" from "anon";

revoke truncate on table "public"."attendance_scouts" from "anon";

revoke update on table "public"."attendance_scouts" from "anon";

revoke delete on table "public"."attendance_scouts" from "authenticated";

revoke insert on table "public"."attendance_scouts" from "authenticated";

revoke references on table "public"."attendance_scouts" from "authenticated";

revoke select on table "public"."attendance_scouts" from "authenticated";

revoke trigger on table "public"."attendance_scouts" from "authenticated";

revoke truncate on table "public"."attendance_scouts" from "authenticated";

revoke update on table "public"."attendance_scouts" from "authenticated";

revoke delete on table "public"."attendance_scouts" from "service_role";

revoke insert on table "public"."attendance_scouts" from "service_role";

revoke references on table "public"."attendance_scouts" from "service_role";

revoke select on table "public"."attendance_scouts" from "service_role";

revoke trigger on table "public"."attendance_scouts" from "service_role";

revoke truncate on table "public"."attendance_scouts" from "service_role";

revoke update on table "public"."attendance_scouts" from "service_role";

revoke delete on table "public"."badges" from "anon";

revoke insert on table "public"."badges" from "anon";

revoke references on table "public"."badges" from "anon";

revoke select on table "public"."badges" from "anon";

revoke trigger on table "public"."badges" from "anon";

revoke truncate on table "public"."badges" from "anon";

revoke update on table "public"."badges" from "anon";

revoke delete on table "public"."badges" from "authenticated";

revoke insert on table "public"."badges" from "authenticated";

revoke references on table "public"."badges" from "authenticated";

revoke select on table "public"."badges" from "authenticated";

revoke trigger on table "public"."badges" from "authenticated";

revoke truncate on table "public"."badges" from "authenticated";

revoke update on table "public"."badges" from "authenticated";

revoke delete on table "public"."badges" from "service_role";

revoke insert on table "public"."badges" from "service_role";

revoke references on table "public"."badges" from "service_role";

revoke select on table "public"."badges" from "service_role";

revoke trigger on table "public"."badges" from "service_role";

revoke truncate on table "public"."badges" from "service_role";

revoke update on table "public"."badges" from "service_role";

revoke delete on table "public"."debug_logs" from "anon";

revoke insert on table "public"."debug_logs" from "anon";

revoke references on table "public"."debug_logs" from "anon";

revoke select on table "public"."debug_logs" from "anon";

revoke trigger on table "public"."debug_logs" from "anon";

revoke truncate on table "public"."debug_logs" from "anon";

revoke update on table "public"."debug_logs" from "anon";

revoke delete on table "public"."debug_logs" from "authenticated";

revoke insert on table "public"."debug_logs" from "authenticated";

revoke references on table "public"."debug_logs" from "authenticated";

revoke select on table "public"."debug_logs" from "authenticated";

revoke trigger on table "public"."debug_logs" from "authenticated";

revoke truncate on table "public"."debug_logs" from "authenticated";

revoke update on table "public"."debug_logs" from "authenticated";

revoke delete on table "public"."debug_logs" from "service_role";

revoke insert on table "public"."debug_logs" from "service_role";

revoke references on table "public"."debug_logs" from "service_role";

revoke select on table "public"."debug_logs" from "service_role";

revoke trigger on table "public"."debug_logs" from "service_role";

revoke truncate on table "public"."debug_logs" from "service_role";

revoke update on table "public"."debug_logs" from "service_role";

revoke delete on table "public"."leader_info" from "anon";

revoke insert on table "public"."leader_info" from "anon";

revoke references on table "public"."leader_info" from "anon";

revoke select on table "public"."leader_info" from "anon";

revoke trigger on table "public"."leader_info" from "anon";

revoke truncate on table "public"."leader_info" from "anon";

revoke update on table "public"."leader_info" from "anon";

revoke delete on table "public"."leader_info" from "authenticated";

revoke insert on table "public"."leader_info" from "authenticated";

revoke references on table "public"."leader_info" from "authenticated";

revoke select on table "public"."leader_info" from "authenticated";

revoke trigger on table "public"."leader_info" from "authenticated";

revoke truncate on table "public"."leader_info" from "authenticated";

revoke update on table "public"."leader_info" from "authenticated";

revoke delete on table "public"."leader_info" from "service_role";

revoke insert on table "public"."leader_info" from "service_role";

revoke references on table "public"."leader_info" from "service_role";

revoke select on table "public"."leader_info" from "service_role";

revoke trigger on table "public"."leader_info" from "service_role";

revoke truncate on table "public"."leader_info" from "service_role";

revoke update on table "public"."leader_info" from "service_role";

revoke delete on table "public"."notices" from "anon";

revoke insert on table "public"."notices" from "anon";

revoke references on table "public"."notices" from "anon";

revoke select on table "public"."notices" from "anon";

revoke trigger on table "public"."notices" from "anon";

revoke truncate on table "public"."notices" from "anon";

revoke update on table "public"."notices" from "anon";

revoke delete on table "public"."notices" from "authenticated";

revoke insert on table "public"."notices" from "authenticated";

revoke references on table "public"."notices" from "authenticated";

revoke select on table "public"."notices" from "authenticated";

revoke trigger on table "public"."notices" from "authenticated";

revoke truncate on table "public"."notices" from "authenticated";

revoke update on table "public"."notices" from "authenticated";

revoke delete on table "public"."notices" from "service_role";

revoke insert on table "public"."notices" from "service_role";

revoke references on table "public"."notices" from "service_role";

revoke select on table "public"."notices" from "service_role";

revoke trigger on table "public"."notices" from "service_role";

revoke truncate on table "public"."notices" from "service_role";

revoke update on table "public"."notices" from "service_role";

revoke delete on table "public"."profiles" from "anon";

revoke insert on table "public"."profiles" from "anon";

revoke references on table "public"."profiles" from "anon";

revoke select on table "public"."profiles" from "anon";

revoke trigger on table "public"."profiles" from "anon";

revoke truncate on table "public"."profiles" from "anon";

revoke update on table "public"."profiles" from "anon";

revoke delete on table "public"."profiles" from "authenticated";

revoke insert on table "public"."profiles" from "authenticated";

revoke references on table "public"."profiles" from "authenticated";

revoke select on table "public"."profiles" from "authenticated";

revoke trigger on table "public"."profiles" from "authenticated";

revoke truncate on table "public"."profiles" from "authenticated";

revoke update on table "public"."profiles" from "authenticated";

revoke delete on table "public"."profiles" from "service_role";

revoke insert on table "public"."profiles" from "service_role";

revoke references on table "public"."profiles" from "service_role";

revoke select on table "public"."profiles" from "service_role";

revoke trigger on table "public"."profiles" from "service_role";

revoke truncate on table "public"."profiles" from "service_role";

revoke update on table "public"."profiles" from "service_role";

revoke delete on table "public"."scout_activities" from "anon";

revoke insert on table "public"."scout_activities" from "anon";

revoke references on table "public"."scout_activities" from "anon";

revoke select on table "public"."scout_activities" from "anon";

revoke trigger on table "public"."scout_activities" from "anon";

revoke truncate on table "public"."scout_activities" from "anon";

revoke update on table "public"."scout_activities" from "anon";

revoke delete on table "public"."scout_activities" from "authenticated";

revoke insert on table "public"."scout_activities" from "authenticated";

revoke references on table "public"."scout_activities" from "authenticated";

revoke select on table "public"."scout_activities" from "authenticated";

revoke trigger on table "public"."scout_activities" from "authenticated";

revoke truncate on table "public"."scout_activities" from "authenticated";

revoke update on table "public"."scout_activities" from "authenticated";

revoke delete on table "public"."scout_activities" from "service_role";

revoke insert on table "public"."scout_activities" from "service_role";

revoke references on table "public"."scout_activities" from "service_role";

revoke select on table "public"."scout_activities" from "service_role";

revoke trigger on table "public"."scout_activities" from "service_role";

revoke truncate on table "public"."scout_activities" from "service_role";

revoke update on table "public"."scout_activities" from "service_role";

revoke delete on table "public"."scout_badges" from "anon";

revoke insert on table "public"."scout_badges" from "anon";

revoke references on table "public"."scout_badges" from "anon";

revoke select on table "public"."scout_badges" from "anon";

revoke trigger on table "public"."scout_badges" from "anon";

revoke truncate on table "public"."scout_badges" from "anon";

revoke update on table "public"."scout_badges" from "anon";

revoke delete on table "public"."scout_badges" from "authenticated";

revoke insert on table "public"."scout_badges" from "authenticated";

revoke references on table "public"."scout_badges" from "authenticated";

revoke select on table "public"."scout_badges" from "authenticated";

revoke trigger on table "public"."scout_badges" from "authenticated";

revoke truncate on table "public"."scout_badges" from "authenticated";

revoke update on table "public"."scout_badges" from "authenticated";

revoke delete on table "public"."scout_badges" from "service_role";

revoke insert on table "public"."scout_badges" from "service_role";

revoke references on table "public"."scout_badges" from "service_role";

revoke select on table "public"."scout_badges" from "service_role";

revoke trigger on table "public"."scout_badges" from "service_role";

revoke truncate on table "public"."scout_badges" from "service_role";

revoke update on table "public"."scout_badges" from "service_role";

revoke delete on table "public"."scout_history" from "anon";

revoke insert on table "public"."scout_history" from "anon";

revoke references on table "public"."scout_history" from "anon";

revoke select on table "public"."scout_history" from "anon";

revoke trigger on table "public"."scout_history" from "anon";

revoke truncate on table "public"."scout_history" from "anon";

revoke update on table "public"."scout_history" from "anon";

revoke delete on table "public"."scout_history" from "authenticated";

revoke insert on table "public"."scout_history" from "authenticated";

revoke references on table "public"."scout_history" from "authenticated";

revoke select on table "public"."scout_history" from "authenticated";

revoke trigger on table "public"."scout_history" from "authenticated";

revoke truncate on table "public"."scout_history" from "authenticated";

revoke update on table "public"."scout_history" from "authenticated";

revoke delete on table "public"."scout_history" from "service_role";

revoke insert on table "public"."scout_history" from "service_role";

revoke references on table "public"."scout_history" from "service_role";

revoke select on table "public"."scout_history" from "service_role";

revoke trigger on table "public"."scout_history" from "service_role";

revoke truncate on table "public"."scout_history" from "service_role";

revoke update on table "public"."scout_history" from "service_role";

revoke delete on table "public"."scouts" from "anon";

revoke insert on table "public"."scouts" from "anon";

revoke references on table "public"."scouts" from "anon";

revoke select on table "public"."scouts" from "anon";

revoke trigger on table "public"."scouts" from "anon";

revoke truncate on table "public"."scouts" from "anon";

revoke update on table "public"."scouts" from "anon";

revoke delete on table "public"."scouts" from "authenticated";

revoke insert on table "public"."scouts" from "authenticated";

revoke references on table "public"."scouts" from "authenticated";

revoke select on table "public"."scouts" from "authenticated";

revoke trigger on table "public"."scouts" from "authenticated";

revoke truncate on table "public"."scouts" from "authenticated";

revoke update on table "public"."scouts" from "authenticated";

revoke delete on table "public"."scouts" from "service_role";

revoke insert on table "public"."scouts" from "service_role";

revoke references on table "public"."scouts" from "service_role";

revoke select on table "public"."scouts" from "service_role";

revoke trigger on table "public"."scouts" from "service_role";

revoke truncate on table "public"."scouts" from "service_role";

revoke update on table "public"."scouts" from "service_role";

revoke delete on table "public"."userroles" from "anon";

revoke insert on table "public"."userroles" from "anon";

revoke references on table "public"."userroles" from "anon";

revoke select on table "public"."userroles" from "anon";

revoke trigger on table "public"."userroles" from "anon";

revoke truncate on table "public"."userroles" from "anon";

revoke update on table "public"."userroles" from "anon";

revoke delete on table "public"."userroles" from "authenticated";

revoke insert on table "public"."userroles" from "authenticated";

revoke references on table "public"."userroles" from "authenticated";

revoke select on table "public"."userroles" from "authenticated";

revoke trigger on table "public"."userroles" from "authenticated";

revoke truncate on table "public"."userroles" from "authenticated";

revoke update on table "public"."userroles" from "authenticated";

revoke delete on table "public"."userroles" from "service_role";

revoke insert on table "public"."userroles" from "service_role";

revoke references on table "public"."userroles" from "service_role";

revoke select on table "public"."userroles" from "service_role";

revoke trigger on table "public"."userroles" from "service_role";

revoke truncate on table "public"."userroles" from "service_role";

revoke update on table "public"."userroles" from "service_role";

alter table "public"."attendance" drop constraint "attendance_activity_type_check";

alter table "public"."badges" drop constraint "valid_badge_type";

alter table "public"."scouts" drop constraint "valid_crews";

alter table "public"."attendance" add constraint "attendance_activity_type_check" CHECK (((activity_type)::text = ANY ((ARRAY['Kayaking'::character varying, 'Swimming'::character varying, 'Meeting'::character varying, 'Camps'::character varying, 'Hikes'::character varying, 'Other'::character varying, 'Service'::character varying])::text[]))) not valid;

alter table "public"."attendance" validate constraint "attendance_activity_type_check";

alter table "public"."badges" add constraint "valid_badge_type" CHECK (((badge_type)::text = ANY ((ARRAY['Proficiency Badge'::character varying, 'Stage Badge'::character varying, 'Event Badge'::character varying, 'Advancement Badge'::character varying, 'Challenge Badge'::character varying])::text[]))) not valid;

alter table "public"."badges" validate constraint "valid_badge_type";

alter table "public"."scouts" add constraint "valid_crews" CHECK (((crew)::text = ANY ((ARRAY['Kingfishers'::character varying, 'Dolphins'::character varying, 'Barracudas'::character varying, 'Orcas'::character varying, 'Falcons'::character varying, 'Swifts'::character varying, 'Marlins'::character varying, 'Terns'::character varying, 'Seals'::character varying, 'Junior Executive'::character varying, 'Senior Executive'::character varying, 'Crewless'::character varying, 'Alpha'::character varying, 'Bravo'::character varying, 'Charlie'::character varying, 'Delta'::character varying])::text[]))) not valid;

alter table "public"."scouts" validate constraint "valid_crews";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.create_scout_if_not_exists(p_user_id uuid, p_full_name text, p_email text, p_rank text, p_crew text)
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- Check if a scout with the given user_id already exists
    IF EXISTS (SELECT 1 FROM public.scouts WHERE user_id = p_user_id) THEN
        -- If yes, update the existing scout
        UPDATE public.scouts
        SET full_name = p_full_name, email = p_email, rank = p_rank, crew = p_crew
        WHERE user_id = p_user_id;
    ELSIF NOT EXISTS (SELECT 1 FROM public.scouts WHERE email = p_email) THEN
        -- If no scout with user_id, and no scout with email, insert the new scout
        INSERT INTO public.scouts (user_id, full_name, email, rank, crew)
        VALUES (p_user_id, p_full_name, p_email, p_rank, p_crew);
    ELSE
        -- If a scout with the email exists but not with the user_id, raise an exception
        RAISE EXCEPTION 'A scout with this email already exists.';
    END IF;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_distinct_activity_types()
 RETURNS TABLE(activity_type text)
 LANGUAGE plpgsql
AS $function$
BEGIN
  RETURN QUERY
  SELECT DISTINCT activity_type
  FROM activities;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_scout_history(p_scout_id integer)
 RETURNS TABLE(rank character varying, crew character varying, start_date timestamp with time zone, end_date timestamp with time zone, duration text)
 LANGUAGE plpgsql
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    sh.rank,
    sh.crew,
    sh.start_date,
    sh.end_date,
    CASE 
      WHEN sh.end_date IS NULL THEN 
        'Current (' || EXTRACT(DAY FROM NOW() - sh.start_date)::TEXT || ' days)'
      ELSE 
        EXTRACT(DAY FROM sh.end_date - sh.start_date)::TEXT || ' days'
    END AS duration
  FROM scout_history sh
  WHERE sh.scout_id = p_scout_id
  ORDER BY sh.start_date DESC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RAISE NOTICE 'handle_new_user triggered for user ID: %', NEW.id;
  RAISE NOTICE 'User email: %', NEW.email;
  RAISE NOTICE 'Raw user metadata: %', NEW.raw_user_meta_data;
  RAISE NOTICE 'Userrole from metadata: %', (NEW.raw_user_meta_data->>'userrole')::text;

  IF (NEW.raw_user_meta_data->>'userrole')::text = 'scout' THEN
    PERFORM public.create_scout_if_not_exists(
      NEW.id,
      NEW.raw_user_meta_data->>'name',
      NEW.email,
      NEW.raw_user_meta_data->>'rank',
      NEW.raw_user_meta_data->>'crew'
    );
  END IF;

  INSERT INTO public.userroles (user_id, userrole)
  VALUES (new.id, new.raw_user_meta_data->>'userrole');

  RETURN new;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.initialize_scout_history()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- Insert initial history record
  INSERT INTO public.scout_history (scout_id, rank, crew)
  VALUES (NEW.id, NEW.rank, NEW.crew);

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.record_scout_history()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- If rank or crew has changed
  IF (OLD.rank <> NEW.rank OR OLD.crew <> NEW.crew) THEN
    -- Close the current period for this scout
    UPDATE scout_history
    SET end_date = NOW()
    WHERE scout_id = NEW.id AND end_date IS NULL;
    
    -- Insert a new record with the updated values
    INSERT INTO scout_history (scout_id, rank, crew)
    VALUES (NEW.id, NEW.rank, NEW.crew);
  END IF;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_scout_email_from_auth()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    IF OLD.email IS DISTINCT FROM NEW.email THEN
        UPDATE public.scouts
        SET email = NEW.email
        WHERE email = OLD.email;
    END IF;
    RETURN NEW;
END;
$function$
;



